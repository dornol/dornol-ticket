stages:
  - build

default:
  image: docker:24.0.5

  services:
    - name: docker:24.0.5-dind
      variables:
        HEALTHCHECK_TCP_PORT: "2375"

  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
    - docker buildx create --use || echo "buildx already exists"

variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA

build-admin-api:
  stage: build
  script:
    - |
      docker buildx build --platform linux/arm64 \
      -t $CI_REGISTRY_IMAGE/admin-api:$CI_COMMIT_SHORT_SHA \
      -t $CI_REGISTRY_IMAGE/admin-api:latest \
      --push ./admin-api

build-admin:
  stage: build
  script:
    - |
      docker buildx build --platform linux/arm64 \
      -t $CI_REGISTRY_IMAGE/admin:$CI_COMMIT_SHORT_SHA \
      -t $CI_REGISTRY_IMAGE/admin:latest \
      --push ./admin
